<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KeyBuilder ‚Äî Chaves de Identifica√ß√£o Interativas</title>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,500;0,9..144,700;1,9..144,400&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg: #faf9f7;
            --bg-card: #ffffff;
            --text: #1a1a1a;
            --text-muted: #6b6b6b;
            --accent: #2d5a3d;
            --accent-light: #e8f0eb;
            --accent-hover: #1e3d29;
            --border: #e5e3df;
            --shadow: 0 2px 20px rgba(0,0,0,0.06);
            --shadow-lg: 0 8px 40px rgba(0,0,0,0.1);
            --radius: 12px;
            --radius-lg: 20px;
        }
        
        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        /* Header */
        header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 2rem;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--accent);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }
        
        .logo h1 {
            font-family: 'Fraunces', serif;
            font-size: 1.5rem;
            font-weight: 500;
            letter-spacing: -0.02em;
        }
        
        nav {
            display: flex;
            gap: 0.5rem;
        }
        
        nav button {
            padding: 0.6rem 1.2rem;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
            color: var(--text-muted);
            transition: all 0.2s;
        }
        
        nav button:hover, nav button.active {
            background: var(--accent-light);
            color: var(--accent);
        }
        
        nav button.active {
            font-weight: 600;
        }
        
        /* Main Layout */
        main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .view { display: none; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }
        
        .card-title {
            font-family: 'Fraunces', serif;
            font-size: 1.25rem;
            font-weight: 500;
        }
        
        /* Buttons */
        .btn {
            padding: 0.7rem 1.4rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: var(--accent);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: var(--accent-light);
            color: var(--accent);
        }
        
        .btn-secondary:hover {
            background: #d5e5da;
        }
        
        .btn-ghost {
            background: transparent;
            color: var(--text-muted);
            border: 1px solid var(--border);
        }
        
        .btn-ghost:hover {
            background: var(--bg);
            color: var(--text);
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 1.25rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        
        input, textarea, select {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95rem;
            transition: all 0.2s;
            background: var(--bg);
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-light);
        }
        
        textarea { resize: vertical; min-height: 100px; }
        
        /* Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .key-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .key-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent), #4a8f64);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .key-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
        
        .key-card:hover::before { opacity: 1; }
        
        .key-card-title {
            font-family: 'Fraunces', serif;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        
        .key-card-meta {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        
        .key-card-stats {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }
        
        .stat {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        
        /* Editor Layout */
        .editor-layout {
            display: grid;
            grid-template-columns: 300px 1fr 320px;
            gap: 1.5rem;
            min-height: calc(100vh - 180px);
        }
        
        @media (max-width: 1200px) {
            .editor-layout {
                grid-template-columns: 1fr;
            }
        }
        
        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .tree-item {
            padding: 0.7rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        
        .tree-item:hover { background: var(--accent-light); }
        .tree-item.selected { background: var(--accent); color: white; }
        
        .tree-item.indent-1 { padding-left: 2rem; }
        .tree-item.indent-2 { padding-left: 3rem; }
        
        /* Character Matrix */
        .matrix-container {
            overflow-x: auto;
        }
        
        .matrix {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        
        .matrix th, .matrix td {
            padding: 0.8rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        .matrix th {
            background: var(--bg);
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .matrix td { vertical-align: middle; }
        
        .state-badge {
            display: inline-block;
            padding: 0.3rem 0.7rem;
            background: var(--accent-light);
            color: var(--accent);
            border-radius: 20px;
            font-size: 0.8rem;
            margin: 0.15rem;
        }
        
        /* AI Panel */
        .ai-panel {
            background: linear-gradient(135deg, #f8faf9 0%, #eef4f0 100%);
            border: 1px solid var(--accent-light);
        }
        
        .ai-chat {
            height: 300px;
            overflow-y: auto;
            padding: 1rem;
            background: var(--bg-card);
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .ai-message {
            margin-bottom: 1rem;
            padding: 0.8rem 1rem;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .ai-message.assistant {
            background: var(--accent-light);
            margin-right: 1.5rem;
        }
        
        .ai-message.user {
            background: var(--accent);
            color: white;
            margin-left: 1.5rem;
        }
        
        .ai-input-group {
            display: flex;
            gap: 0.5rem;
        }
        
        .ai-input-group input {
            flex: 1;
            background: white;
        }
        
        /* Identification View */
        .id-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        @media (max-width: 900px) {
            .id-layout { grid-template-columns: 1fr; }
        }
        
        .character-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .character-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            transition: all 0.2s;
        }
        
        .character-item:hover {
            border-color: var(--accent);
        }
        
        .character-name {
            font-weight: 600;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .states-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .state-option {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            background: white;
        }
        
        .state-option:hover {
            border-color: var(--accent);
            background: var(--accent-light);
        }
        
        .state-option.selected {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        
        .taxa-results {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .taxon-result {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s;
        }
        
        .taxon-result.eliminated {
            opacity: 0.4;
            order: 999;
        }
        
        .taxon-result.match {
            border-color: var(--accent);
            background: var(--accent-light);
        }
        
        .taxon-name {
            font-family: 'Fraunces', serif;
            font-style: italic;
            font-size: 1.05rem;
        }
        
        .match-score {
            background: var(--accent);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        /* Progress Bar */
        .progress-container {
            margin-bottom: 1.5rem;
        }
        
        .progress-bar {
            height: 8px;
            background: var(--border);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #4a8f64);
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 2rem;
            backdrop-filter: blur(4px);
        }
        
        .modal-overlay.active { display: flex; }
        
        .modal {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalIn 0.3s ease;
        }
        
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .modal-title {
            font-family: 'Fraunces', serif;
            font-size: 1.5rem;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
            line-height: 1;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }
        
        .empty-state-icon {
            width: 80px;
            height: 80px;
            background: var(--accent-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2rem;
        }
        
        .empty-state h3 {
            font-family: 'Fraunces', serif;
            color: var(--text);
            margin-bottom: 0.5rem;
        }
        
        /* Tags */
        .tag {
            display: inline-block;
            padding: 0.25rem 0.6rem;
            background: var(--accent-light);
            color: var(--accent);
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        
        /* Tooltips & Helpers */
        .helper-text {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.4rem;
        }
        
        /* Actions Bar */
        .actions-bar {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        /* Inline Edit */
        .inline-edit {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .inline-edit input {
            flex: 1;
            padding: 0.5rem;
        }
        
        /* Image Upload */
        .image-upload {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .image-upload:hover {
            border-color: var(--accent);
            background: var(--accent-light);
        }
        
        .image-preview {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 1rem;
        }
        
        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            header { padding: 1rem; }
            .header-content { flex-wrap: wrap; }
            main { padding: 1rem; }
            nav { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">üîë</div>
                <h1>KeyBuilder</h1>
            </div>
            <nav>
                <button class="active" data-view="dashboard">Minhas Chaves</button>
                <button data-view="editor">Editor</button>
                <button data-view="identify">Identificar</button>
                <button onclick="openSettings()" style="margin-left:1rem" title="Configura√ß√µes">‚öôÔ∏è Config</button>
            </nav>
        </div>
    </header>

    <main>
        <!-- Dashboard View -->
        <div id="dashboard" class="view active">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Suas Chaves de Identifica√ß√£o</h2>
                    <button class="btn btn-primary" onclick="showNewKeyModal()">
                        <span>+</span> Nova Chave
                    </button>
                </div>
                <div id="keys-grid" class="dashboard-grid">
                    <!-- Keys will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Editor View -->
        <div id="editor" class="view">
            <div class="editor-layout">
                <!-- Left Sidebar - Structure -->
                <div class="sidebar">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Estrutura</h3>
                            <button class="btn btn-secondary" onclick="showAddCharacterModal()">+ Caractere</button>
                        </div>
                        <div id="character-tree">
                            <!-- Character tree will be rendered here -->
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">T√°xons</h3>
                            <button class="btn btn-secondary" onclick="showAddTaxonModal()">+ T√°xon</button>
                        </div>
                        <div id="taxa-tree">
                            <!-- Taxa tree will be rendered here -->
                        </div>
                    </div>
                </div>

                <!-- Main Editor Area -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Matriz de Caracteres</h3>
                        <div class="actions-bar">
                            <button class="btn btn-ghost" onclick="exportKey()">üì§ Exportar</button>
                            <button class="btn btn-ghost" onclick="importKey()">üì• Importar</button>
                        </div>
                    </div>
                    <div class="matrix-container">
                        <table class="matrix" id="character-matrix">
                            <!-- Matrix will be rendered here -->
                        </table>
                    </div>
                </div>

                <!-- Right Sidebar - AI Assistant -->
                <div class="card ai-panel">
                    <div class="card-header">
                        <h3 class="card-title">‚ú® Assistente IA</h3>
                        <span class="tag">Gemini 2.5</span>
                    </div>
                    <div class="ai-chat" id="ai-chat">
                        <div class="ai-message assistant">
                            Ol√°! Sou seu assistente para criar chaves de identifica√ß√£o. Posso ajudar a:
                            <br><br>
                            ‚Ä¢ Sugerir caracteres diagn√≥sticos<br>
                            ‚Ä¢ Gerar descri√ß√µes de estados<br>
                            ‚Ä¢ Otimizar sua matriz<br>
                            ‚Ä¢ Identificar inconsist√™ncias
                        </div>
                    </div>
                    <div class="ai-input-group">
                        <input type="text" id="ai-input" placeholder="Pergunte algo..." onkeypress="if(event.key==='Enter')sendAIMessage()">
                        <button class="btn btn-primary" onclick="sendAIMessage()">Enviar</button>
                    </div>
                    <p class="helper-text" style="margin-top:0.75rem">Configure sua API key nas configura√ß√µes para ativar.</p>
                </div>
            </div>
        </div>

        <!-- Identification View -->
        <div id="identify" class="view">
            <div class="card" style="margin-bottom:1.5rem">
                <div class="card-header">
                    <div>
                        <h3 class="card-title">Identifica√ß√£o Interativa</h3>
                        <p class="helper-text" style="margin-top:0.25rem">Selecione os estados observados para filtrar os t√°xons</p>
                    </div>
                    <div class="actions-bar">
                        <select id="key-selector" onchange="loadKeyForIdentification()" style="width:auto">
                            <option value="">Selecione uma chave...</option>
                        </select>
                        <button class="btn btn-ghost" onclick="resetIdentification()">üîÑ Reiniciar</button>
                    </div>
                </div>
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="id-progress" style="width:0%"></div>
                    </div>
                    <div class="progress-text">
                        <span id="remaining-taxa">0 t√°xons restantes</span>
                        <span id="used-chars">0 caracteres usados</span>
                    </div>
                </div>
            </div>
            
            <div class="id-layout">
                <div>
                    <h4 style="margin-bottom:1rem;font-family:'Fraunces',serif">Caracteres Dispon√≠veis</h4>
                    <div id="id-characters" class="character-list">
                        <!-- Characters for identification -->
                    </div>
                </div>
                <div>
                    <h4 style="margin-bottom:1rem;font-family:'Fraunces',serif">T√°xons Poss√≠veis</h4>
                    <div id="id-results" class="taxa-results">
                        <!-- Identification results -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- New Key Modal -->
    <div class="modal-overlay" id="new-key-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Nova Chave</h3>
                <button class="modal-close" onclick="closeModal('new-key-modal')">&times;</button>
            </div>
            <form onsubmit="createNewKey(event)">
                <div class="form-group">
                    <label>Nome da Chave</label>
                    <input type="text" id="new-key-name" placeholder="Ex: √Årvores do Cerrado" required>
                </div>
                <div class="form-group">
                    <label>Descri√ß√£o</label>
                    <textarea id="new-key-desc" placeholder="Descreva o objetivo desta chave..."></textarea>
                </div>
                <div class="form-group">
                    <label>Grupo Taxon√¥mico</label>
                    <input type="text" id="new-key-group" placeholder="Ex: Fabaceae">
                </div>
                <div style="display:flex;gap:0.75rem;justify-content:flex-end;margin-top:1.5rem">
                    <button type="button" class="btn btn-ghost" onclick="closeModal('new-key-modal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Criar Chave</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Character Modal -->
    <div class="modal-overlay" id="add-character-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Novo Caractere</h3>
                <button class="modal-close" onclick="closeModal('add-character-modal')">&times;</button>
            </div>
            <form onsubmit="addCharacter(event)">
                <div class="form-group">
                    <label>Nome do Caractere</label>
                    <input type="text" id="char-name" placeholder="Ex: Forma da folha" required>
                </div>
                <div class="form-group">
                    <label>Estados (um por linha)</label>
                    <textarea id="char-states" placeholder="simples&#10;composta&#10;bipinada" required></textarea>
                    <p class="helper-text">Liste todos os estados poss√≠veis deste caractere</p>
                </div>
                <div class="form-group">
                    <label>Tipo</label>
                    <select id="char-type">
                        <option value="exclusive">Exclusivo (apenas um estado)</option>
                        <option value="multiple">M√∫ltiplo (v√°rios estados)</option>
                    </select>
                </div>
                <div style="display:flex;gap:0.75rem;justify-content:flex-end;margin-top:1.5rem">
                    <button type="button" class="btn btn-ghost" onclick="closeModal('add-character-modal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Adicionar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Taxon Modal -->
    <div class="modal-overlay" id="add-taxon-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Novo T√°xon</h3>
                <button class="modal-close" onclick="closeModal('add-taxon-modal')">&times;</button>
            </div>
            <form onsubmit="addTaxon(event)">
                <div class="form-group">
                    <label>Nome Cient√≠fico</label>
                    <input type="text" id="taxon-name" placeholder="Ex: Bowdichia virgilioides" required>
                </div>
                <div class="form-group">
                    <label>Nome Comum (opcional)</label>
                    <input type="text" id="taxon-common" placeholder="Ex: Sucupira">
                </div>
                <div class="form-group">
                    <label>Notas</label>
                    <textarea id="taxon-notes" placeholder="Informa√ß√µes adicionais..."></textarea>
                </div>
                <div class="form-group">
                    <label>Imagem</label>
                    <div class="image-upload" onclick="document.getElementById('taxon-image').click()">
                        <span>üì∑ Clique para adicionar imagem</span>
                        <input type="file" id="taxon-image" accept="image/*" style="display:none" onchange="previewImage(this)">
                    </div>
                    <img id="taxon-image-preview" class="image-preview" style="display:none">
                </div>
                <div style="display:flex;gap:0.75rem;justify-content:flex-end;margin-top:1.5rem">
                    <button type="button" class="btn btn-ghost" onclick="closeModal('add-taxon-modal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Adicionar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Configura√ß√µes</h3>
                <button class="modal-close" onclick="closeModal('settings-modal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Gemini API Key</label>
                <input type="password" id="gemini-api-key" placeholder="Sua chave da API Gemini">
                <p class="helper-text">Obtenha em: <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a></p>
            </div>
            <div style="display:flex;gap:0.75rem;justify-content:flex-end;margin-top:1.5rem">
                <button class="btn btn-primary" onclick="saveSettings()">Salvar</button>
            </div>
        </div>
    </div>

    <script>
        // ===== DATA STORE =====
        let store = {
            keys: [],
            currentKey: null,
            settings: { geminiApiKey: '' },
            idState: { selectedStates: {}, eliminatedTaxa: [] }
        };

        // Load from localStorage
        function loadStore() {
            const saved = localStorage.getItem('keybuilder');
            if (saved) {
                store = { ...store, ...JSON.parse(saved) };
            }
            // Demo data if empty
            if (store.keys.length === 0) {
                store.keys.push({
                    id: 'demo-1',
                    name: '√Årvores do Cerrado',
                    description: 'Chave para identifica√ß√£o das principais √°rvores nativas do Cerrado brasileiro',
                    group: 'Angiospermas',
                    created: new Date().toISOString(),
                    characters: [
                        { id: 'c1', name: 'Tipo de folha', type: 'exclusive', states: ['Simples', 'Composta', 'Bipinada'] },
                        { id: 'c2', name: 'Margem foliar', type: 'exclusive', states: ['Inteira', 'Serreada', 'Crenada'] },
                        { id: 'c3', name: 'Tipo de casca', type: 'exclusive', states: ['Lisa', 'Fissurada', 'Corticosa', 'Descamante'] },
                        { id: 'c4', name: 'Cor da flor', type: 'multiple', states: ['Branca', 'Amarela', 'Rosa', 'Roxa'] }
                    ],
                    taxa: [
                        { id: 't1', name: 'Bowdichia virgilioides', common: 'Sucupira-preta', states: { c1: ['Composta'], c2: ['Inteira'], c3: ['Fissurada'], c4: ['Roxa'] } },
                        { id: 't2', name: 'Caryocar brasiliense', common: 'Pequi', states: { c1: ['Composta'], c2: ['Serreada'], c3: ['Corticosa'], c4: ['Branca', 'Amarela'] } },
                        { id: 't3', name: 'Qualea grandiflora', common: 'Pau-terra', states: { c1: ['Simples'], c2: ['Inteira'], c3: ['Corticosa'], c4: ['Amarela'] } },
                        { id: 't4', name: 'Tabebuia aurea', common: 'Ip√™-amarelo', states: { c1: ['Composta'], c2: ['Inteira'], c3: ['Fissurada'], c4: ['Amarela'] } },
                        { id: 't5', name: 'Handroanthus impetiginosus', common: 'Ip√™-roxo', states: { c1: ['Composta'], c2: ['Serreada'], c3: ['Fissurada'], c4: ['Rosa', 'Roxa'] } }
                    ]
                });
            }
        }

        function saveStore() {
            localStorage.setItem('keybuilder', JSON.stringify(store));
        }

        // ===== NAVIGATION =====
        document.querySelectorAll('nav button').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.view).classList.add('active');
                if (btn.dataset.view === 'identify') populateKeySelector();
            });
        });

        // ===== MODAL HELPERS =====
        function showModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function showNewKeyModal() { showModal('new-key-modal'); }
        function showAddCharacterModal() { showModal('add-character-modal'); }
        function showAddTaxonModal() { showModal('add-taxon-modal'); }

        // ===== KEY MANAGEMENT =====
        function createNewKey(e) {
            e.preventDefault();
            const key = {
                id: 'key-' + Date.now(),
                name: document.getElementById('new-key-name').value,
                description: document.getElementById('new-key-desc').value,
                group: document.getElementById('new-key-group').value,
                created: new Date().toISOString(),
                characters: [],
                taxa: []
            };
            store.keys.push(key);
            store.currentKey = key.id;
            saveStore();
            closeModal('new-key-modal');
            renderDashboard();
            document.querySelector('[data-view="editor"]').click();
            e.target.reset();
        }

        function selectKey(id) {
            store.currentKey = id;
            saveStore();
            document.querySelector('[data-view="editor"]').click();
            renderEditor();
        }

        function deleteKey(id, e) {
            e.stopPropagation();
            if (confirm('Excluir esta chave permanentemente?')) {
                store.keys = store.keys.filter(k => k.id !== id);
                if (store.currentKey === id) store.currentKey = null;
                saveStore();
                renderDashboard();
            }
        }

        function getCurrentKey() {
            return store.keys.find(k => k.id === store.currentKey);
        }

        // ===== RENDER FUNCTIONS =====
        function renderDashboard() {
            const grid = document.getElementById('keys-grid');
            if (store.keys.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column:1/-1">
                        <div class="empty-state-icon">üåø</div>
                        <h3>Nenhuma chave criada</h3>
                        <p>Crie sua primeira chave de identifica√ß√£o</p>
                    </div>
                `;
                return;
            }
            grid.innerHTML = store.keys.map(key => `
                <div class="key-card" onclick="selectKey('${key.id}')">
                    <span class="tag">${key.group || 'Sem grupo'}</span>
                    <h3 class="key-card-title" style="margin-top:0.75rem">${key.name}</h3>
                    <p class="key-card-meta">${key.description || 'Sem descri√ß√£o'}</p>
                    <div class="key-card-stats">
                        <span class="stat">üìä ${key.characters.length} caracteres</span>
                        <span class="stat">üå± ${key.taxa.length} t√°xons</span>
                        <button class="btn btn-ghost" style="margin-left:auto;padding:0.4rem 0.8rem" onclick="deleteKey('${key.id}', event)">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function renderEditor() {
            const key = getCurrentKey();
            if (!key) {
                document.getElementById('character-tree').innerHTML = '<p class="helper-text">Selecione uma chave</p>';
                document.getElementById('taxa-tree').innerHTML = '';
                document.getElementById('character-matrix').innerHTML = '';
                return;
            }
            
            // Character tree
            document.getElementById('character-tree').innerHTML = key.characters.length === 0 
                ? '<p class="helper-text">Adicione caracteres para come√ßar</p>'
                : key.characters.map(c => `
                    <div class="tree-item" onclick="editCharacter('${c.id}')">
                        <span>${c.type === 'multiple' ? '‚òëÔ∏è' : '‚ö™'}</span>
                        <span>${c.name}</span>
                        <span style="margin-left:auto;color:var(--text-muted);font-size:0.8rem">${c.states.length}</span>
                    </div>
                `).join('');
            
            // Taxa tree
            document.getElementById('taxa-tree').innerHTML = key.taxa.length === 0
                ? '<p class="helper-text">Adicione t√°xons para identificar</p>'
                : key.taxa.map(t => `
                    <div class="tree-item" onclick="editTaxon('${t.id}')">
                        <span>üå±</span>
                        <span style="font-style:italic">${t.name}</span>
                    </div>
                `).join('');
            
            // Matrix
            renderMatrix();
        }

        function renderMatrix() {
            const key = getCurrentKey();
            if (!key || key.characters.length === 0 || key.taxa.length === 0) {
                document.getElementById('character-matrix').innerHTML = `
                    <tr><td class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <h3>Matriz vazia</h3>
                        <p>Adicione caracteres e t√°xons para preencher a matriz</p>
                    </td></tr>
                `;
                return;
            }
            
            let html = '<thead><tr><th>T√°xon</th>';
            key.characters.forEach(c => {
                html += `<th>${c.name}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            key.taxa.forEach(t => {
                html += `<tr><td style="font-style:italic;font-weight:500">${t.name}</td>`;
                key.characters.forEach(c => {
                    const states = t.states?.[c.id] || [];
                    html += '<td>';
                    if (states.length === 0) {
                        html += `<button class="btn btn-ghost" style="padding:0.3rem 0.6rem;font-size:0.8rem" onclick="openStateSelector('${t.id}','${c.id}')">+ definir</button>`;
                    } else {
                        html += states.map(s => `<span class="state-badge">${s}</span>`).join('');
                        html += `<button class="btn btn-ghost" style="padding:0.2rem 0.4rem;font-size:0.7rem;margin-left:0.25rem" onclick="openStateSelector('${t.id}','${c.id}')">‚úèÔ∏è</button>`;
                    }
                    html += '</td>';
                });
                html += '</tr>';
            });
            html += '</tbody>';
            
            document.getElementById('character-matrix').innerHTML = html;
        }

        // ===== CHARACTER & TAXON MANAGEMENT =====
        function addCharacter(e) {
            e.preventDefault();
            const key = getCurrentKey();
            if (!key) return alert('Selecione uma chave primeiro');
            
            const char = {
                id: 'c-' + Date.now(),
                name: document.getElementById('char-name').value,
                states: document.getElementById('char-states').value.split('\n').filter(s => s.trim()),
                type: document.getElementById('char-type').value
            };
            key.characters.push(char);
            saveStore();
            closeModal('add-character-modal');
            renderEditor();
            e.target.reset();
        }

        function addTaxon(e) {
            e.preventDefault();
            const key = getCurrentKey();
            if (!key) return alert('Selecione uma chave primeiro');
            
            const taxon = {
                id: 't-' + Date.now(),
                name: document.getElementById('taxon-name').value,
                common: document.getElementById('taxon-common').value,
                notes: document.getElementById('taxon-notes').value,
                states: {}
            };
            key.taxa.push(taxon);
            saveStore();
            closeModal('add-taxon-modal');
            renderEditor();
            e.target.reset();
            document.getElementById('taxon-image-preview').style.display = 'none';
        }

        function openStateSelector(taxonId, charId) {
            const key = getCurrentKey();
            const char = key.characters.find(c => c.id === charId);
            const taxon = key.taxa.find(t => t.id === taxonId);
            const current = taxon.states?.[charId] || [];
            
            const html = `
                <div class="modal-header">
                    <h3 class="modal-title">${char.name}</h3>
                    <button class="modal-close" onclick="closeModal('state-selector-modal')">&times;</button>
                </div>
                <p class="helper-text" style="margin-bottom:1rem">Selecione os estados para <em>${taxon.name}</em></p>
                <div class="states-grid" style="margin-bottom:1.5rem">
                    ${char.states.map(s => `
                        <div class="state-option ${current.includes(s) ? 'selected' : ''}" 
                             onclick="toggleState(this, '${taxonId}', '${charId}', '${s}')">${s}</div>
                    `).join('')}
                </div>
                <div style="display:flex;justify-content:flex-end">
                    <button class="btn btn-primary" onclick="closeModal('state-selector-modal')">Conclu√≠do</button>
                </div>
            `;
            
            let modal = document.getElementById('state-selector-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.id = 'state-selector-modal';
                modal.innerHTML = '<div class="modal"></div>';
                document.body.appendChild(modal);
            }
            modal.querySelector('.modal').innerHTML = html;
            showModal('state-selector-modal');
        }

        function toggleState(el, taxonId, charId, state) {
            const key = getCurrentKey();
            const taxon = key.taxa.find(t => t.id === taxonId);
            const char = key.characters.find(c => c.id === charId);
            
            if (!taxon.states) taxon.states = {};
            if (!taxon.states[charId]) taxon.states[charId] = [];
            
            const idx = taxon.states[charId].indexOf(state);
            if (idx === -1) {
                if (char.type === 'exclusive') {
                    taxon.states[charId] = [state];
                    el.parentElement.querySelectorAll('.state-option').forEach(s => s.classList.remove('selected'));
                } else {
                    taxon.states[charId].push(state);
                }
                el.classList.add('selected');
            } else {
                taxon.states[charId].splice(idx, 1);
                el.classList.remove('selected');
            }
            
            saveStore();
            renderMatrix();
        }

        // ===== IDENTIFICATION =====
        function populateKeySelector() {
            const selector = document.getElementById('key-selector');
            selector.innerHTML = '<option value="">Selecione uma chave...</option>' +
                store.keys.map(k => `<option value="${k.id}">${k.name}</option>`).join('');
        }

        function loadKeyForIdentification() {
            const keyId = document.getElementById('key-selector').value;
            if (!keyId) return;
            store.currentKey = keyId;
            store.idState = { selectedStates: {}, eliminatedTaxa: [] };
            renderIdentification();
        }

        function resetIdentification() {
            store.idState = { selectedStates: {}, eliminatedTaxa: [] };
            renderIdentification();
        }

        function renderIdentification() {
            const key = getCurrentKey();
            if (!key) return;
            
            const { selectedStates, eliminatedTaxa } = store.idState;
            
            // Calculate remaining taxa
            let remaining = key.taxa.filter(t => !eliminatedTaxa.includes(t.id));
            Object.entries(selectedStates).forEach(([charId, states]) => {
                if (states.length > 0) {
                    remaining = remaining.filter(t => {
                        const taxonStates = t.states?.[charId] || [];
                        return states.some(s => taxonStates.includes(s));
                    });
                }
            });
            
            // Update progress
            const progress = key.taxa.length > 0 
                ? Math.round(((key.taxa.length - remaining.length) / key.taxa.length) * 100) 
                : 0;
            document.getElementById('id-progress').style.width = progress + '%';
            document.getElementById('remaining-taxa').textContent = `${remaining.length} t√°xons restantes`;
            document.getElementById('used-chars').textContent = `${Object.keys(selectedStates).filter(k => selectedStates[k].length > 0).length} caracteres usados`;
            
            // Render characters
            document.getElementById('id-characters').innerHTML = key.characters.map(c => {
                const selected = selectedStates[c.id] || [];
                return `
                    <div class="character-item">
                        <div class="character-name">
                            <span>${c.type === 'multiple' ? '‚òëÔ∏è' : '‚ö™'}</span>
                            ${c.name}
                        </div>
                        <div class="states-grid">
                            ${c.states.map(s => `
                                <div class="state-option ${selected.includes(s) ? 'selected' : ''}"
                                     onclick="selectIdState('${c.id}', '${s}', '${c.type}')">${s}</div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Render results with match scores
            const results = key.taxa.map(t => {
                let matchCount = 0;
                let totalSelected = 0;
                Object.entries(selectedStates).forEach(([charId, states]) => {
                    if (states.length > 0) {
                        totalSelected++;
                        const taxonStates = t.states?.[charId] || [];
                        if (states.some(s => taxonStates.includes(s))) matchCount++;
                    }
                });
                const score = totalSelected > 0 ? Math.round((matchCount / totalSelected) * 100) : 100;
                const isMatch = remaining.some(r => r.id === t.id);
                return { ...t, score, isMatch };
            }).sort((a, b) => b.score - a.score);
            
            document.getElementById('id-results').innerHTML = results.map(t => `
                <div class="taxon-result ${t.isMatch ? 'match' : 'eliminated'}">
                    <div>
                        <div class="taxon-name">${t.name}</div>
                        ${t.common ? `<div style="font-size:0.85rem;color:var(--text-muted)">${t.common}</div>` : ''}
                    </div>
                    <span class="match-score">${t.score}%</span>
                </div>
            `).join('');
        }

        function selectIdState(charId, state, type) {
            if (!store.idState.selectedStates[charId]) {
                store.idState.selectedStates[charId] = [];
            }
            
            const states = store.idState.selectedStates[charId];
            const idx = states.indexOf(state);
            
            if (idx === -1) {
                if (type === 'exclusive') {
                    store.idState.selectedStates[charId] = [state];
                } else {
                    states.push(state);
                }
            } else {
                states.splice(idx, 1);
            }
            
            renderIdentification();
        }

        // ===== AI ASSISTANT =====
        async function sendAIMessage() {
            const input = document.getElementById('ai-input');
            const message = input.value.trim();
            if (!message) return;
            
            const chat = document.getElementById('ai-chat');
            chat.innerHTML += `<div class="ai-message user">${message}</div>`;
            input.value = '';
            chat.scrollTop = chat.scrollHeight;
            
            const apiKey = store.settings.geminiApiKey;
            if (!apiKey) {
                chat.innerHTML += `<div class="ai-message assistant">‚ö†Ô∏è Configure sua API key do Gemini nas configura√ß√µes para usar o assistente IA.</div>`;
                chat.scrollTop = chat.scrollHeight;
                return;
            }
            
            // Loading
            chat.innerHTML += `<div class="ai-message assistant" id="ai-loading"><span class="loading"></span> Pensando...</div>`;
            chat.scrollTop = chat.scrollHeight;
            
            const key = getCurrentKey();
            const context = key ? `
                Contexto da chave atual:
                - Nome: ${key.name}
                - Grupo: ${key.group}
                - Caracteres: ${key.characters.map(c => `${c.name} (${c.states.join(', ')})`).join('; ')}
                - T√°xons: ${key.taxa.map(t => t.name).join(', ')}
            ` : 'Nenhuma chave selecionada.';
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `Voc√™ √© um especialista em taxonomia e chaves de identifica√ß√£o biol√≥gica. Ajude o usu√°rio a criar e melhorar chaves de identifica√ß√£o interativas no estilo LUCID.
                                
${context}

Pergunta do usu√°rio: ${message}

Responda de forma concisa e √∫til em portugu√™s.`
                            }]
                        }]
                    })
                });
                
                const data = await response.json();
                document.getElementById('ai-loading').remove();
                
                const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || 'Desculpe, n√£o consegui processar sua pergunta.';
                chat.innerHTML += `<div class="ai-message assistant">${reply}</div>`;
            } catch (err) {
                document.getElementById('ai-loading').remove();
                chat.innerHTML += `<div class="ai-message assistant">‚ùå Erro ao conectar com a API: ${err.message}</div>`;
            }
            
            chat.scrollTop = chat.scrollHeight;
        }

        // ===== IMPORT/EXPORT =====
        function exportKey() {
            const key = getCurrentKey();
            if (!key) return alert('Selecione uma chave para exportar');
            
            const json = JSON.stringify(key, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${key.name.replace(/\s+/g, '_')}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importKey() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const key = JSON.parse(text);
                    key.id = 'key-' + Date.now(); // New ID
                    store.keys.push(key);
                    store.currentKey = key.id;
                    saveStore();
                    renderDashboard();
                    renderEditor();
                    alert('Chave importada com sucesso!');
                } catch (err) {
                    alert('Erro ao importar: ' + err.message);
                }
            };
            input.click();
        }

        // ===== SETTINGS =====
        function openSettings() {
            document.getElementById('gemini-api-key').value = store.settings.geminiApiKey || '';
            showModal('settings-modal');
        }
        
        function saveSettings() {
            store.settings.geminiApiKey = document.getElementById('gemini-api-key').value;
            saveStore();
            closeModal('settings-modal');
            alert('Configura√ß√µes salvas!');
        }

        // ===== IMAGE PREVIEW =====
        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.getElementById('taxon-image-preview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // ===== INIT =====
        loadStore();
        renderDashboard();
        if (store.currentKey) renderEditor();
        
        // Keyboard shortcut for settings
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === ',') {
                e.preventDefault();
                document.getElementById('gemini-api-key').value = store.settings.geminiApiKey || '';
                showModal('settings-modal');
            }
        });
    </script>
</body>
</html>
